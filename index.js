(()=>{function m(e,t){e(t),t.children.forEach(r=>m(e,r))}function f(e){let t=e.value.position.x+Math.abs(e.value.dimensions.width/2),r=e.value.position.y+Math.abs(e.value.dimensions.height/2);return{x:t,y:r}}function w(e,t){let r=performance.now(),o=t();return console.log(`${e} (${performance.now()-r}ms)`),o}function A(){let e=document.getElementById("canvas");if(!e)throw new Error("Could not find canvas element.");e.width=window.innerWidth,e.height=window.innerHeight;let t=e.getContext("2d");if(!t)throw new Error("Could not get context.");return{context:t,canvasDimensions:{width:e.width,height:e.height}}}function x(e,t,r){let o=[];for(let n=0;n<t;n++){o[n]=[];for(let i=0;i<e;i++)o[n][i]=r}return o}function D(e){let t={width:0,height:0};return m(r=>{if(!r.value.position||!r.value.dimensions)return;let o=r.value.position.x+r.value.dimensions.width;o>t.width&&(t.width=o);let n=r.value.position.y+r.value.dimensions.height;n>t.height&&(t.height=n)},e),t}function C(e,t){let r=Math.floor(e.width/t.width),o=Math.floor(e.height/t.height);return r<o?r:o}function M(e){let{context:t,canvasDimensions:r}=A(),o=D(e),n=C(r,o),i=x(o.width,o.height,6);E(i,e),H(i,e),$(t,n,r),G(t,n,i),_(t,n,e),K(t,n,e)}function E(e,t){m(r=>{if(!(!r.value.position||!r.value.dimensions))for(let o=0;o<r.value.dimensions.height;o++)for(let n=0;n<r.value.dimensions.width;n++){let i=r.value.position.y+o,s=r.value.position.x+n;switch(r.value.type){case"start":e[i][s]=1;break;case"room":e[i][s]=2;break;case"boss":e[i][s]=3;break;case"end":e[i][s]=5;break}}},t)}function H(e,t){m(r=>{if(r.value.corridor)for(let o=0;o<r.value.corridor.dimensions.height;o++)for(let n=0;n<r.value.corridor.dimensions.width;n++){let i=r.value.corridor.position.y+o,s=r.value.corridor.position.x+n;e[i][s]=4}},t)}function $(e,t,r){e.beginPath(),e.lineWidth=.5,e.strokeStyle="rgba(0,200,0,0.5)";for(let o=.5;o<r.width;o+=t)e.moveTo(o,0),e.lineTo(o,r.height);for(let o=.5;o<r.height;o+=t)e.moveTo(0,o),e.lineTo(r.width,o);e.stroke(),e.closePath()}function G(e,t,r){for(let o=0;o<r.length;o++)for(let n=0;n<r[o].length;n++)V(e,t,n,o,r[o][n])}function V(e,t,r,o,n){switch(n){case 1:e.fillStyle="rgba(0,127,0,1)";break;case 2:e.fillStyle="rgba(0,0,127,1)";break;case 3:e.fillStyle="rgba(127,0,127,1)";break;case 4:e.fillStyle="rgba(127,127,0,1)";break;case 5:e.fillStyle="rgba(127,0,0,1)";break;case 6:e.fillStyle="rgba(0,0,0,0)";break}e.fillRect(r*t,o*t,t,t)}function _(e,t,r){e.beginPath(),e.lineWidth=1.5,e.strokeStyle="white",m(o=>{let n=f(o);o.children.forEach(i=>{let s=f(i);e.moveTo(n.x*t,n.y*t),e.lineTo(s.x*t,s.y*t)})},r),e.stroke(),e.closePath()}function K(e,t,r){e.font="16px Arial",e.fillStyle="white",e.textAlign="center",m(o=>{let n=f(o);e.fillText(o.value.id,n.x*t,n.y*t)},r)}var g=class{constructor(t,r=null){this.value=t,this.children=[],this.parent=r}addChild(t){t.parent=this,this.children.push(t)}copyValue(){return{...this.value}}};var R=class{constructor(){this.boxes={}}addBox(t){this.boxes[t.id]={...t}}removeBox(t){delete this.boxes[t]}collides(t){let r=Object.keys(this.boxes);for(let o=0;o<r.length;o++){let n=r[o],i=this.boxes[n];if(t.startX<i.endX&&t.endX>i.startX&&t.startY<i.endY&&t.endY>i.startY)return!0}return!1}};function c(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function X(e){return e[Math.floor(Math.random()*e.length)]}function b(e){return{id:e.value.id,startX:e.value.position.x,endX:e.value.position.x+e.value.dimensions.width,startY:e.value.position.y,endY:e.value.position.y+e.value.dimensions.height}}function T(e){let t=0,r=0;m(o=>{o.value.position.x<t&&(t=o.value.position.x),o.value.position.y<r&&(r=o.value.position.y)},e),m(o=>{o.value.position.x+=Math.abs(t),o.value.position.y+=Math.abs(r),o.value.corridor&&(o.value.corridor.position.x+=Math.abs(t),o.value.corridor.position.y+=Math.abs(r))},e)}function p(e,t,r,o){let n=Math.max(e,r),i=Math.min(t,o);return n>i?null:[n,i]}function O(e,t){if(e.startY>=t.endY)return"n";if(e.endY<=t.startY)return"s";if(e.startX>=t.endX)return"w";if(e.endX<=t.startX)return"e";throw new Error(`Could not determine child "${t.id}" direction against parent "${e.id}".`)}function I(e){let t=j(e);return q(t),T(t),t}function j(e){return Y(e,"start")}function Y(e,t){let r=e[t];if(!r)throw new Error(`Could not find "${t}" to generate tree.`);let o=new g({id:r.id,type:r.type});return r.children.map(n=>{let i=Y(e,n);o.addChild(i)}),o}function q(e){let t=new R,r=[e],o=1e3;for(;r.length>0;){let n=r.shift();try{k(t,n),U(t,n)}catch{if(o===0)throw new Error("Could not backtrack room generation under ");let s=n.parent;r.unshift(s),t.removeBox(`room-${s.value.id}`),t.removeBox(`corridor-${s.value.id}`);for(let a of s?.children)t.removeBox(`room-${a.value.id}`),t.removeBox(`corridor-${a.value.id}`);o-=1}for(let i of n.children)r.push(i)}return e}function k(e,t,r=20){if(r===0)throw new Error(`Could not place room under "${20}" iterations.`);let o=Z(t),n=Q(t,o),i={id:`room-${t.value.id}`,startX:n.x,startY:n.y,endX:n.x+o.width,endY:n.y+o.height};if(e.collides(i))return k(e,t,r-1);t.value.dimensions=o,t.value.position=n,e.addBox(i)}function U(e,t,r=20){if(!t.parent)return;if(r===0)throw new Error(`Could not place corridor under "${20}" iterations.`);let o=L(t.parent,t),n={id:`corridor-${t.value.id}`,startX:o.position.x,startY:o.position.y,endX:o.position.x+o.dimensions.width,endY:o.position.y+o.dimensions.height};if(e.collides(n))throw new Error("Could not place corridor as it is colliding.");t.value.corridor=o,e.addBox(n)}function Z(e){switch(e.value.type){case"start":return{width:c(5,6),height:c(5,6)};case"room":return{width:c(8,12),height:c(8,12)};case"boss":return{width:c(12,20),height:c(12,20)};case"end":return{width:c(5,7),height:c(5,7)}}}function Q(e,t){if(!t)throw new Error(`Cannot generate position without dimensions on node "${e.value.id}".`);if(!e.parent)return{x:0-Math.floor(t.width/2),y:0-Math.floor(t.height/2)};let r=X(["n","s","e","w"]),o=c(3,6),n=4,i=b(e.parent);switch(r){case"n":{let s=i.startX-t.width+n,a=i.endX-n;return{x:c(s,a),y:i.startY-o-t.height}}case"w":{let s=i.startY-t.height+n,a=i.endY-n;return{x:i.startX-o-t.width,y:c(s,a)}}case"s":{let s=i.startX-t.width+n,a=i.endX-n;return{x:c(s,a),y:i.endY+o}}case"e":{let s=i.startY-t.height+n,a=i.endY-n;return{x:i.endX+o,y:c(s,a)}}}}function L(e,t){let r=b(e),o=b(t),n={x:0,y:0},i={width:0,height:0},s=O(r,o);switch(s){case"n":{let a=Math.abs(r.startY-o.endY),d=v(r,o,s),u=Math.abs(d[0]-d[1])-4,h=Math.floor(u/2);n.x=d[0]+h,n.y=o.endY,i.width=4,i.height=a}break;case"s":{let a=Math.abs(r.endY-o.startY),d=v(r,o,s),u=Math.abs(d[0]-d[1])-4,h=Math.floor(u/2);n.x=d[0]+h,n.y=r.endY,i.width=4,i.height=a}break;case"e":{let a=Math.abs(r.endX-o.startX),d=v(r,o,s),u=Math.abs(d[0]-d[1])-4,h=Math.floor(u/2);n.x=r.endX,n.y=d[0]+h,i.width=a,i.height=4}break;case"w":{let a=Math.abs(r.startX-o.endX),d=v(r,o,s),u=Math.abs(d[0]-d[1])-4,h=Math.floor(u/2);n.x=o.endX,n.y=d[0]+h,i.width=a,i.height=4}break}return{position:n,dimensions:i}}function v(e,t,r){let o;switch(r){case"n":o=p(e.startX,e.endX,t.startX,t.endX);break;case"s":o=p(e.startX,e.endX,t.startX,t.endX);break;case"e":o=p(e.startY,e.endY,t.startY,t.endY);break;case"w":o=p(e.startY,e.endY,t.startY,t.endY);break}if(!o)throw new Error("Could not find overlapping segment.");return o}var S={start:{id:"start",type:"start",children:["A","G"]},A:{id:"A",type:"room",children:["B","C"]},G:{id:"G",type:"room",children:["H","I"]},H:{id:"H",type:"room",children:[]},I:{id:"I",type:"room",children:[]},B:{id:"B",type:"room",children:["D","E"]},C:{id:"C",type:"room",children:[]},D:{id:"D",type:"room",children:["F","boss"]},E:{id:"E",type:"room",children:["J","K"]},J:{id:"J",type:"room",children:[]},K:{id:"K",type:"room",children:[]},F:{id:"F",type:"room",children:[]},boss:{id:"boss",type:"boss",children:["end"]},end:{id:"end",type:"end",children:[]}};function W(){let e=w("Generate \u2705",()=>I(S));w("Draw \u2705",()=>M(e))}window.onload=()=>{W();let e=document.getElementById("button-generate");e.onclick=()=>W();let t=document.getElementById("button-github");t.onclick=()=>window.open("https://github.com/halftheopposite/graph-dungeon-generator")};})();
