(()=>{function m(t,e){t(e),e.children.forEach(n=>m(t,n))}function A(t){let e=t.value.position.x+Math.abs(t.value.dimensions.width/2),n=t.value.position.y+Math.abs(t.value.dimensions.height/2);return{x:e,y:n}}function C(t,e){let n=performance.now(),o=e();return console.log(`${t} (${performance.now()-n}ms)`),o}function N(){let t=document.getElementById("canvas");if(!t)throw new Error("Could not find canvas element.");t.width=window.innerWidth,t.height=window.innerHeight;let e=t.getContext("2d");if(!e)throw new Error("Could not get context.");return{context:e,canvasDimensions:{width:t.width,height:t.height}}}function B(t,e,n){let o=[];for(let r=0;r<e;r++){o[r]=[];for(let i=0;i<t;i++)o[r][i]=n}return o}function b(t){return t.map(e=>[...e])}function S(t,e){m(n=>{!n.value.position||!n.value.dimensions||(n.value.position.y+=e,n.value.position.x+=e,n.value.corridor&&(n.value.corridor.position.y+=e,n.value.corridor.position.x+=e))},t)}function E(t,e){let n={width:0,height:0};return m(o=>{if(!o.value.position||!o.value.dimensions)return;let r=o.value.position.x+o.value.dimensions.width;r>n.width&&(n.width=r);let i=o.value.position.y+o.value.dimensions.height;i>n.height&&(n.height=i)},t),n.width+=e*2,n.height+=e*2,n}function X(t,e){let n=Math.floor(t.width/e.width),o=Math.floor(t.height/e.height);return n<o?n:o}var z={2:1,8:2,10:3,11:4,16:5,18:6,22:7,24:8,26:9,27:10,30:11,31:12,64:13,66:14,72:15,74:16,75:17,80:18,82:19,86:20,88:21,90:22,91:23,94:24,95:25,104:26,106:27,107:28,120:29,122:30,123:31,126:32,127:33,208:34,210:35,214:36,216:37,218:38,219:39,222:40,223:41,246:36,248:42,250:43,251:44,254:45,255:46,0:47};function Y(t){let e=b(t);for(let n=0;n<e.length;n++)for(let o=0;o<e[n].length;o++)e[n][o]===1&&(e[n][o]=Q(o,n,e));return e}function Q(t,e,n){let o=0;return p(t,e,"north",n)&&(o|=2),p(t,e,"west",n)&&(o|=8),p(t,e,"east",n)&&(o|=16),p(t,e,"south",n)&&(o|=64),o&2&&o&8&&p(t,e,"north-west",n)&&(o|=1),o&2&&o&16&&p(t,e,"north-east",n)&&(o|=4),o&64&&o&8&&p(t,e,"south-west",n)&&(o|=32),o&64&&o&16&&p(t,e,"south-east",n)&&(o|=128),z[o]}function p(t,e,n,o){let r=t===0,i=t===o[e].length-1,a=e===0,c=e===o.length-1;switch(n){case"north":return a||o[e-1][t]>0;case"west":return r||o[e][t-1]>0;case"east":return i||o[e][t+1]>0;case"south":return c||o[e+1][t]>0;case"north-west":return r||a||o[e-1][t-1]>0;case"north-east":return i||a||o[e-1][t+1]>0;case"south-west":return r||c||o[e+1][t-1]>0;case"south-east":return i||c||o[e+1][t+1]>0}}function l(t){let e=new Image;return e.src=t,e}var s={ground:l("assets/tiles/ground.png"),n:l("assets/tiles/n.png"),s:l("assets/tiles/s.png"),e:l("assets/tiles/e.png"),w:l("assets/tiles/w.png"),ne:l("assets/tiles/ne.png"),nw:l("assets/tiles/nw.png"),"w-e":l("assets/tiles/w-e.png"),"n-nw-w":l("assets/tiles/n-nw-w.png"),"n-ne-e":l("assets/tiles/n-ne-e.png"),all:l("assets/tiles/all.png")},k={0:s.ground,1:s.s,2:s.s,3:s.s,4:s.s,5:s.s,7:s.s,6:s.s,8:s.s,9:s.s,10:s.s,11:s.s,12:s.s,13:s["w-e"],14:s["w-e"],15:s["w-e"],16:s["w-e"],17:s["w-e"],18:s["w-e"],19:s["w-e"],20:s["w-e"],21:s["w-e"],22:s["w-e"],23:s["w-e"],24:s["w-e"],25:s["w-e"],26:s["n-ne-e"],27:s["n-ne-e"],28:s.e,29:s["n-ne-e"],30:s["n-ne-e"],31:s.e,32:s["n-ne-e"],33:s.e,34:s["n-nw-w"],35:s["n-nw-w"],36:s.w,37:s["n-nw-w"],38:s["n-nw-w"],39:s["n-nw-w"],40:s.w,41:s.w,42:s.n,43:s.n,44:s.ne,45:s.nw,46:s.all,47:s.s};function L(t,e={}){let{context:n,canvasDimensions:o}=N(),r=e.padding&&!isNaN(e.padding)&&e.padding>0?e.padding:0,i=!!e.debugWidgets,a=E(t,r),c=X(o,a),u=B(a.width,a.height,6);S(t,r),u=Z(u,t),u=ee(u,t),se(n,c,u),re(n,c,u),i&&(te(n,c,o),oe(n,c,t),ne(n,c,t))}function Z(t,e){let n=b(t);return m(o=>{if(!(!o.value.position||!o.value.dimensions))for(let r=0;r<o.value.dimensions.height;r++)for(let i=0;i<o.value.dimensions.width;i++){let a=o.value.position.y+r,c=o.value.position.x+i;switch(o.value.type){case"start":n[a][c]=1;break;case"room":n[a][c]=2;break;case"boss":n[a][c]=3;break;case"end":n[a][c]=5;break}}},e),n}function ee(t,e){let n=b(t);return m(o=>{if(o.value.corridor)for(let r=0;r<o.value.corridor.dimensions.height;r++)for(let i=0;i<o.value.corridor.dimensions.width;i++){let a=o.value.corridor.position.y+r,c=o.value.corridor.position.x+i;n[a][c]=4}},e),n}function te(t,e,n){t.beginPath(),t.lineWidth=.5,t.strokeStyle="rgba(0,200,0,0.5)";for(let o=.5;o<n.width;o+=e)t.moveTo(o,0),t.lineTo(o,n.height);for(let o=.5;o<n.height;o+=e)t.moveTo(0,o),t.lineTo(n.width,o);t.stroke(),t.closePath()}function oe(t,e,n){t.beginPath(),t.lineWidth=1.5,t.strokeStyle="white",m(o=>{let r=A(o);o.children.forEach(i=>{let a=A(i);t.moveTo(r.x*e,r.y*e),t.lineTo(a.x*e,a.y*e)})},n),t.stroke(),t.closePath()}function ne(t,e,n){t.font="16px Arial",t.fillStyle="white",t.textAlign="center",m(o=>{let r=A(o);t.fillText(o.value.id,r.x*e,r.y*e)},n)}function re(t,e,n){for(let o=0;o<n.length;o++)for(let r=0;r<n[o].length;r++)ie(t,e,r,o,n[o][r])}function ie(t,e,n,o,r){switch(r){case 6:t.fillStyle="rgba(0,0,0,0)";break;case 1:t.fillStyle="rgba(0,127,0,0.5)";break;case 2:t.fillStyle="rgba(0,0,127,0.5)";break;case 3:t.fillStyle="rgba(127,0,127,0.5)";break;case 4:t.fillStyle="rgba(127,127,0,0.5)";break;case 5:t.fillStyle="rgba(127,0,0,0.5)";break}t.fillRect(n*e,o*e,e,e)}function se(t,e,n){let o=ae(n),r=Y(o);for(let i=0;i<r.length;i++)for(let a=0;a<r[i].length;a++){let c=r[i][a],u=k[c];u&&t.drawImage(u,a*e,i*e,e,e)}}function ae(t){let e=b(t);for(let n=0;n<e.length;n++)for(let o=0;o<e[n].length;o++)e[n][o]=e[n][o]===6?1:0;return e}var y=class{constructor(){this.boxes={}}addBox(e){this.boxes[e.id]={...e}}removeBox(e){delete this.boxes[e]}collides(e){let n=Object.keys(this.boxes);for(let o=0;o<n.length;o++){let r=n[o],i=this.boxes[r];if(e.startX<i.endX&&e.endX>i.startX&&e.startY<i.endY&&e.endY>i.startY)return!0}return!1}};var D=class{constructor(e,n=null){this.value=e,this.children=[],this.parent=n}addChild(e){e.parent=this,this.children.push(e)}copyValue(){return{...this.value}}};function _(t){return W(t,"start")}function W(t,e){let n=t[e];if(!n)throw new Error(`Could not find "${e}" to generate tree.`);let o=new D({id:n.id,type:n.type});return n.children.map(r=>{let i=W(t,r);o.addChild(i)}),o}function d(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function H(t){return t[Math.floor(Math.random()*t.length)]}function T(t){return{id:t.value.id,startX:t.value.position.x,endX:t.value.position.x+t.value.dimensions.width,startY:t.value.position.y,endY:t.value.position.y+t.value.dimensions.height}}function G(t){let e=0,n=0;m(o=>{o.value.position.x<e&&(e=o.value.position.x),o.value.position.y<n&&(n=o.value.position.y)},t),m(o=>{o.value.position.x+=Math.abs(e),o.value.position.y+=Math.abs(n),o.value.corridor&&(o.value.corridor.position.x+=Math.abs(e),o.value.corridor.position.y+=Math.abs(n))},t)}function R(t,e,n,o){let r=Math.max(t,n),i=Math.min(e,o);return r>i?null:[r,i]}function $(t,e){if(t.startY>=e.endY)return"n";if(t.endY<=e.startY)return"s";if(t.startX>=e.endX)return"w";if(t.endX<=e.startX)return"e";throw new Error(`Could not determine child "${e.id}" direction against parent "${t.id}".`)}function K(t){let e=_(t);return de(e),G(e),e}function de(t){let e=new y,n=[t],o=1e3;for(;n.length>0;){let r=n.shift();try{U(e,r),me(e,r)}catch{if(o===0)throw new Error(`Could not backtrack room generation under ${1e3}`);let a=r.parent;n.unshift(a),e.removeBox(`room-${a.value.id}`),e.removeBox(`corridor-${a.value.id}`);for(let c of a?.children)e.removeBox(`room-${c.value.id}`),e.removeBox(`corridor-${c.value.id}`);o-=1}for(let i of r.children)n.push(i)}return t}function U(t,e,n=20){if(n===0)throw new Error(`Could not place room under "${20}" iterations.`);let o=le(e),r=he(e,o),i=r.x-2,a=r.y-2,c=i+o.width+2,u=a+o.height+2,w={id:`room-${e.value.id}`,startX:i,startY:a,endX:c,endY:u};if(t.collides(w))return U(t,e,n-1);e.value.dimensions=o,e.value.position=r,t.addBox(w)}function me(t,e,n=20){if(!e.parent)return;if(n===0)throw new Error(`Could not place corridor under "${20}" iterations.`);let o=pe(e.parent,e),r={id:`corridor-${e.value.id}`,startX:o.position.x,startY:o.position.y,endX:o.position.x+o.dimensions.width,endY:o.position.y+o.dimensions.height};e.value.corridor=o,t.addBox(r)}function le(t){switch(t.value.type){case"start":return{width:d(5,6),height:d(5,6)};case"room":return{width:d(8,12),height:d(8,12)};case"boss":return{width:d(12,20),height:d(12,20)};case"end":return{width:d(5,7),height:d(5,7)}}}function he(t,e){if(!e)throw new Error(`Cannot generate position without dimensions on node "${t.value.id}".`);if(!t.parent)return{x:0-Math.floor(e.width/2),y:0-Math.floor(e.height/2)};let n=H(["n","s","e","w"]),o=d(3,6),r=4,i=T(t.parent);switch(n){case"n":{let a=i.startX-e.width+r,c=i.endX-r;return{x:d(a,c),y:i.startY-o-e.height}}case"w":{let a=i.startY-e.height+r,c=i.endY-r;return{x:i.startX-o-e.width,y:d(a,c)}}case"s":{let a=i.startX-e.width+r,c=i.endX-r;return{x:d(a,c),y:i.endY+o}}case"e":{let a=i.startY-e.height+r,c=i.endY-r;return{x:i.endX+o,y:d(a,c)}}}}function pe(t,e){let n=T(t),o=T(e),r={x:0,y:0},i={width:0,height:0},a=$(n,o);switch(a){case"n":{let c=Math.abs(n.startY-o.endY),u=x(n,o,a),g=Math.abs(u[0]-u[1])-4,f=Math.floor(g/2);r.x=u[0]+f,r.y=o.endY,i.width=4,i.height=c}break;case"s":{let c=Math.abs(n.endY-o.startY),u=x(n,o,a),g=Math.abs(u[0]-u[1])-4,f=Math.floor(g/2);r.x=u[0]+f,r.y=n.endY,i.width=4,i.height=c}break;case"e":{let c=Math.abs(n.endX-o.startX),u=x(n,o,a),g=Math.abs(u[0]-u[1])-4,f=Math.floor(g/2);r.x=n.endX,r.y=u[0]+f,i.width=c,i.height=4}break;case"w":{let c=Math.abs(n.startX-o.endX),u=x(n,o,a),g=Math.abs(u[0]-u[1])-4,f=Math.floor(g/2);r.x=o.endX,r.y=u[0]+f,i.width=c,i.height=4}break}return{position:r,dimensions:i}}function x(t,e,n){let o;switch(n){case"n":o=R(t.startX,t.endX,e.startX,e.endX);break;case"s":o=R(t.startX,t.endX,e.startX,e.endX);break;case"e":o=R(t.startY,t.endY,e.startY,e.endY);break;case"w":o=R(t.startY,t.endY,e.startY,e.endY);break}if(!o)throw new Error("Could not find overlapping segment.");return o}var M={start:{id:"start",type:"start",children:["A","F"]},A:{id:"A",type:"room",children:["B"]},B:{id:"B",type:"room",children:["C","D"]},C:{id:"C",type:"room",children:[]},D:{id:"D",type:"room",children:["E"]},E:{id:"E",type:"room",children:[]},F:{id:"F",type:"room",children:["G","H"]},G:{id:"G",type:"room",children:[]},H:{id:"H",type:"room",children:["I"]},I:{id:"I",type:"room",children:["J"]},J:{id:"J",type:"room",children:["K","L"]},K:{id:"K",type:"room",children:["boss"]},L:{id:"L",type:"room",children:[]},boss:{id:"boss",type:"boss",children:["end"]},end:{id:"end",type:"end",children:[]}};var J={start:{id:"start",type:"start",children:["A","B"]},A:{id:"A",type:"room",children:["C"]},B:{id:"B",type:"room",children:["D"]},C:{id:"C",type:"room",children:["E","F"]},D:{id:"D",type:"room",children:[]},E:{id:"E",type:"room",children:["boss"]},F:{id:"F",type:"room",children:[]},boss:{id:"boss",type:"boss",children:["G","end"]},G:{id:"G",type:"room",children:[]},end:{id:"end",type:"end",children:[]}};var j={start:{id:"start",type:"start",children:["A"]},A:{id:"A",type:"room",children:["B1","B2"]},B1:{id:"B1",type:"room",children:["C"]},B2:{id:"B2",type:"room",children:["C"]},C:{id:"C",type:"room",children:["D"]},D:{id:"D",type:"room",children:[]},E:{id:"E",type:"room",children:["boss","F"]},F:{id:"F",type:"room",children:[]},boss:{id:"boss",type:"boss",children:["end"]},end:{id:"end",type:"end",children:[]}};var q={start:{id:"start",type:"start",children:["A"]},A:{id:"A",type:"room",children:["B","C"]},B:{id:"B",type:"room",children:[]},C:{id:"C",type:"room",children:["boss"]},boss:{id:"boss",type:"boss",children:["end"]},end:{id:"end",type:"end",children:[]}};var v=M;function O(){let t=C("Generate \u2705",()=>K(v));C("Draw \u2705",()=>L(t,{padding:4,debugWidgets:!0}))}window.onload=()=>{O();let t=document.getElementById("select-graph");t.onchange=o=>{switch(o.currentTarget.value){case"small":v=q;break;case"medium":v=J;break;case"medium-circular":v=j;break;case"large":v=M;break}O()};let e=document.getElementById("button-generate");e.onclick=()=>O();let n=document.getElementById("button-github");n.onclick=()=>window.open("https://github.com/halftheopposite/graph-dungeon-generator")};})();
